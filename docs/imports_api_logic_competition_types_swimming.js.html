<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>imports/api/logic/competition_types/swimming.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Account.html">Account</a></li><li><a href="Athlete.html">Athlete</a><ul class='methods'><li data-type='method'><a href="Athlete.html#.decryptFromDatabase">decryptFromDatabase</a></li><li data-type='method'><a href="Athlete.html#addMeasurement">addMeasurement</a></li><li data-type='method'><a href="Athlete.html#check">check</a></li><li data-type='method'><a href="Athlete.html#encryptForDatabase">encryptForDatabase</a></li><li data-type='method'><a href="Athlete.html#getFullName">getFullName</a></li><li data-type='method'><a href="Athlete.html#getPlain">getPlain</a></li><li data-type='method'><a href="Athlete.html#getShortName">getShortName</a></li></ul></li><li><a href="Data.html">Data</a><ul class='methods'><li data-type='method'><a href="Data.html#findEncrypted">findEncrypted</a></li><li data-type='method'><a href="Data.html#getPlain">getPlain</a></li><li data-type='method'><a href="Data.html#push">push</a></li></ul></li><li><a href="Log.html">Log</a><ul class='methods'><li data-type='method'><a href="Log.html#clear">clear</a></li><li data-type='method'><a href="Log.html#custom">custom</a></li><li data-type='method'><a href="Log.html#disable">disable</a></li><li data-type='method'><a href="Log.html#enable">enable</a></li><li data-type='method'><a href="Log.html#error">error</a></li><li data-type='method'><a href="Log.html#getAsString">getAsString</a></li><li data-type='method'><a href="Log.html#getAsStringWithLevel">getAsStringWithLevel</a></li><li data-type='method'><a href="Log.html#getAsStringWithMinLevel">getAsStringWithMinLevel</a></li><li data-type='method'><a href="Log.html#info">info</a></li><li data-type='method'><a href="Log.html#merge">merge</a></li><li data-type='method'><a href="Log.html#warning">warning</a></li></ul></li><li><a href="SessionAccount.html">SessionAccount</a><ul class='methods'><li data-type='method'><a href="SessionAccount.html#canViewResults">canViewResults</a></li><li data-type='method'><a href="SessionAccount.html#get">get</a></li><li data-type='method'><a href="SessionAccount.html#isAdminAccount">isAdminAccount</a></li><li data-type='method'><a href="SessionAccount.html#isGroupAccount">isGroupAccount</a></li><li data-type='method'><a href="SessionAccount.html#isLoggedIn">isLoggedIn</a></li><li data-type='method'><a href="SessionAccount.html#isStationAccount">isStationAccount</a></li><li data-type='method'><a href="SessionAccount.html#login">login</a></li><li data-type='method'><a href="SessionAccount.html#logout">logout</a></li><li data-type='method'><a href="SessionAccount.html#setProcessing">setProcessing</a></li><li data-type='method'><a href="SessionAccount.html#store">store</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="AccountManager.html">AccountManager</a><ul class='methods'><li data-type='method'><a href="AccountManager.html#.getAdminAccount">getAdminAccount</a></li><li data-type='method'><a href="AccountManager.html#.getGroupAccount">getGroupAccount</a></li><li data-type='method'><a href="AccountManager.html#.getOutputAccount">getOutputAccount</a></li><li data-type='method'><a href="AccountManager.html#.getStationAccount">getStationAccount</a></li><li data-type='method'><a href="AccountManager.html#.inputPermitted">inputPermitted</a></li><li data-type='method'><a href="AccountManager.html#.login">login</a></li><li data-type='method'><a href="AccountManager.html#.logout">logout</a></li><li data-type='method'><a href="AccountManager.html#.retrieveAccounts">retrieveAccounts</a></li><li data-type='method'><a href="AccountManager.html#.viewPermitted">viewPermitted</a></li></ul></li><li><a href="Athletics.html">Athletics</a><ul class='methods'><li data-type='method'><a href="Athletics.html#.calculate">calculate</a></li><li data-type='method'><a href="Athletics.html#.calculateOne">calculateOne</a></li><li data-type='method'><a href="Athletics.html#.canDoSportType">canDoSportType</a></li><li data-type='method'><a href="Athletics.html#.generateCertificate">generateCertificate</a></li><li data-type='method'><a href="Athletics.html#.getCertificateInfo">getCertificateInfo</a></li><li data-type='method'><a href="Athletics.html#.getInformation">getInformation</a></li><li data-type='method'><a href="Athletics.html#.getNameOfSportType">getNameOfSportType</a></li><li data-type='method'><a href="Athletics.html#.getSports">getSports</a></li><li data-type='method'><a href="Athletics.html#.getSportType">getSportType</a></li><li data-type='method'><a href="Athletics.html#.getValidData">getValidData</a></li><li data-type='method'><a href="Athletics.html#.validate">validate</a></li></ul></li><li><a href="Crypto.html">Crypto</a><ul class='methods'><li data-type='method'><a href="Crypto.html#.encrypt">encrypt</a></li><li data-type='method'><a href="Crypto.html#.generateAC">generateAC</a></li><li data-type='method'><a href="Crypto.html#.generateLoginToken">generateLoginToken</a></li><li data-type='method'><a href="Crypto.html#.generatePrivHash">generatePrivHash</a></li><li data-type='method'><a href="Crypto.html#.generatePubHash">generatePubHash</a></li><li data-type='method'><a href="Crypto.html#.tryDecrypt">tryDecrypt</a></li></ul></li><li><a href="DBInterface.html">DBInterface</a><ul class='methods'><li data-type='method'><a href="DBInterface.html#.activateCompetition">activateCompetition</a></li><li data-type='method'><a href="DBInterface.html#.certificateUpdate">certificateUpdate</a></li><li data-type='method'><a href="DBInterface.html#.generateCertificates">generateCertificates</a></li><li data-type='method'><a href="DBInterface.html#.getActivatedSports">getActivatedSports</a></li><li data-type='method'><a href="DBInterface.html#.getActiveContest">getActiveContest</a></li><li data-type='method'><a href="DBInterface.html#.getActiveContestID">getActiveContestID</a></li><li data-type='method'><a href="DBInterface.html#.getAthletesByCompetition">getAthletesByCompetition</a></li><li data-type='method'><a href="DBInterface.html#.getAthletesOfAccounts">getAthletesOfAccounts</a></li><li data-type='method'><a href="DBInterface.html#.getCompetitionName">getCompetitionName</a></li><li data-type='method'><a href="DBInterface.html#.getCompetitionSportTypes">getCompetitionSportTypes</a></li><li data-type='method'><a href="DBInterface.html#.getCompetitionType">getCompetitionType</a></li><li data-type='method'><a href="DBInterface.html#.getCompetitionTypeID">getCompetitionTypeID</a></li><li data-type='method'><a href="DBInterface.html#.getEditInformation">getEditInformation</a></li><li data-type='method'><a href="DBInterface.html#.getGenericID">getGenericID</a></li><li data-type='method'><a href="DBInterface.html#.getServerIPs">getServerIPs</a></li><li data-type='method'><a href="DBInterface.html#.isReady">isReady</a></li><li data-type='method'><a href="DBInterface.html#.removeCompetition">removeCompetition</a></li><li data-type='method'><a href="DBInterface.html#.setSportTypeState">setSportTypeState</a></li><li data-type='method'><a href="DBInterface.html#.waitForReady">waitForReady</a></li><li data-type='method'><a href="DBInterface.html#.writeCompetition">writeCompetition</a></li></ul></li><li><a href="Gymnastics.html">Gymnastics</a><ul class='methods'><li data-type='method'><a href="Gymnastics.html#.calculate">calculate</a></li><li data-type='method'><a href="Gymnastics.html#.canDoSportType">canDoSportType</a></li><li data-type='method'><a href="Gymnastics.html#.generateCertificate">generateCertificate</a></li><li data-type='method'><a href="Gymnastics.html#.getCertificateInfo">getCertificateInfo</a></li><li data-type='method'><a href="Gymnastics.html#.getInformation">getInformation</a></li><li data-type='method'><a href="Gymnastics.html#.getNameOfSportType">getNameOfSportType</a></li><li data-type='method'><a href="Gymnastics.html#.getSports">getSports</a></li><li data-type='method'><a href="Gymnastics.html#.getSportType">getSportType</a></li><li data-type='method'><a href="Gymnastics.html#.getValidData">getValidData</a></li><li data-type='method'><a href="Gymnastics.html#.validate">validate</a></li></ul></li><li><a href="Swimming.html">Swimming</a><ul class='methods'><li data-type='method'><a href="Swimming.html#.calculate">calculate</a></li><li data-type='method'><a href="Swimming.html#.canDoSportType">canDoSportType</a></li><li data-type='method'><a href="Swimming.html#.generateCertificate">generateCertificate</a></li><li data-type='method'><a href="Swimming.html#.getCertificateInfo">getCertificateInfo</a></li><li data-type='method'><a href="Swimming.html#.getInformation">getInformation</a></li><li data-type='method'><a href="Swimming.html#.getNameOfSportType">getNameOfSportType</a></li><li data-type='method'><a href="Swimming.html#.getSports">getSports</a></li><li data-type='method'><a href="Swimming.html#.getSportType">getSportType</a></li><li data-type='method'><a href="Swimming.html#.getValidData">getValidData</a></li><li data-type='method'><a href="Swimming.html#.validate">validate</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#canViewResults">canViewResults</a></li><li><a href="global.html#checkAdminLogin">checkAdminLogin</a></li><li><a href="global.html#checkLogin">checkLogin</a></li><li><a href="global.html#filterUndefined">filterUndefined</a></li><li><a href="global.html#genRandomCode">genRandomCode</a></li><li><a href="global.html#genUUID">genUUID</a></li><li><a href="global.html#getAccountByPassphrase">getAccountByPassphrase</a></li><li><a href="global.html#getAcsFromAccounts">getAcsFromAccounts</a></li><li><a href="global.html#getAdminAccount">getAdminAccount</a></li><li><a href="global.html#getCompetitionTypeByID">getCompetitionTypeByID</a></li><li><a href="global.html#getGroupNames">getGroupNames</a></li><li><a href="global.html#getLoginObject">getLoginObject</a></li><li><a href="global.html#getLoginToken">getLoginToken</a></li><li><a href="global.html#getStationNames">getStationNames</a></li><li><a href="global.html#getStationNamesAsArray">getStationNamesAsArray</a></li><li><a href="global.html#initCollections">initCollections</a></li><li><a href="global.html#isAdminAccount">isAdminAccount</a></li><li><a href="global.html#isGroupAccount">isGroupAccount</a></li><li><a href="global.html#isStationAccount">isStationAccount</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">imports/api/logic/competition_types/swimming.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {filterUndefined} from "./../general";

/**
 * Object containing all information and functions required for Swimming contest.
 * @public
 * @namespace
 */
export let Swimming = {
    /** @constant {number} */
    maxAge: 18,

    /**
     * @typedef {Object} SwimmingCalculation
     * @property {number} a - A sport type specific number required to calculate the score
     * @property {number} c - A sport type specific number required to calculate the score
     * @property {number} d - A sport type specific number required to calculate the score
     * @property {ConversionFactors} conversionFactor - An object containing information about conversion factors for all start classes
     */

    /**
     * @typedef {Object} SwimmingGenderData
     * @property {SwimmingCalculation} scoreCalculation - Information about the score calculation
     */

    /**
     * @typedef {Object} SwimmingSportData
     * @property {string} id - The id of the sport type
     * @property {string} name - The human readable name for the sport type
     * @property {number} category - The category of the sport type (eg. sprinting)
     * @property {string} unit - The human readable unit for the measurements (eg. m (meter))
     * @property {string} description - A description of the sport type. It may contain information about how to measure in this sport type.
     */

    /**
     * Returns a list of sport types associated with the ct athletics.
     * @returns {SwimmingSportData[]}
     */
    getSports: function () {
        return require('./../../../data/swimming/sports.json');
    },

    /**
     * Returns the SportType by its id
     * @param {string} stID - The id of the sport type
     * @return {object|undefined}
     */
    getSportType: function (stID) {
        const data = Swimming.getSports();

        for (let d in data) {
            if (!data.hasOwnProperty(d)) continue;
            if (data[d].id === stID) return data[d];
        }
        return undefined;
    },

    /**
     * Returns the name of a SportType
     * @param {string} stID - The id of the sport type
     * @return {string}
     */
    getNameOfSportType: function (stID) {
        const sport_type = Swimming.getSportType(stID);
        if (sport_type) return sport_type.name;
        else return "Unknown";
    },

    getScoreTable: function () {
        return require('./../../../data/swimming/score_table.json');
    },
    /**
     * Returns whether a given athlete can do the sport type with the id stID.
     * @param {Log} log - A log object
     * @param {Athlete} athlete - The Athlete
     * @param {string} stID - The string id of the sport type
     * @returns {{canDoSport, dataObject, log}}
     */
    canDoSportType: function (log, athlete, stID) {
        //collect information
        let baseInformation = _.find(this.getSports(), function (st) {
            return st.id === stID;
        });

        // check information
        if (!baseInformation) {
            log.error(stID + ' ist keine gültige Sport ID.');
            return {
                canDoSport: false,
                dataObject: undefined
            };
        }

        // filter information
        const genderInfo = athlete.isMale ? baseInformation.m : baseInformation.w;
        //noinspection JSUnresolvedVariable
        const handicapData = genderInfo.scoreCalculation.conversionFactor[athlete.handicap];

        const baseScoreTable = this.getScoreTable();

        const genderScoreInfo = athlete.isMale ? baseScoreTable.m : baseScoreTable.w;
        const scoreTable = genderScoreInfo[athlete.tableAge][stID];

        // save important information
        const dataObject = {
            stID: stID,
            name: baseInformation.name,
            category: baseInformation.category,
            unit: baseInformation.unit,
            genderInfo: genderInfo,
            scoreTable: scoreTable,
            conversionFactor: handicapData === undefined ? 1.0 : handicapData,
            conversionAddend: (athlete.handicap !== '0' &amp;&amp; (stID === 'st_diving_push' || stID === 'st_diving')) ? 1.0 : 0.0
        };

        let canDoSport = true;

        // check age
        if (scoreTable === undefined) {
            log.warning(athlete.getFullName() + ' hat kein gültiges Alter für ' + baseInformation.name + '.');
            canDoSport = false;
        }

        return {
            canDoSport: canDoSport,
            dataObject: dataObject
        };
    },

    /**
     * Validates the data of an athlete and adds more information to it. A copy of the data is returned. Without the write_private_hash the data is just decrypted without a write-permission check.
     * @param {Log} log - A log object
     * @param {Athlete} athlete - The Athlete
     * @param {Account[]} accounts - A list of accounts used to decrypt
     * @param {boolean} requireSignature - Only decrypt data if the signature can be verified. Should be true for final certificate creation.
     * * @returns {object[]}
     */
    getValidData: function (log, athlete, accounts, requireSignature) {
        //get the plain data from the athlete (unencrypted)
        const plain = athlete.getPlain(log, accounts, requireSignature);

        // filter data with more then on point
        const tmpData = _.filter(plain, function (dataObject) {
            return _.max(dataObject.measurements.data) > 0;
        });

        // temporary store this in that
        const that = this; //TODO alternative?

        // Add information
        return filterUndefined(_.map(tmpData, function (dataObject) {
            //noinspection JSUnresolvedVariable
            let canDoSportObject = that.canDoSportType(log, athlete, dataObject.stID.data);

            // add measurement to general information
            if (canDoSportObject.dataObject !== undefined) {
                canDoSportObject.dataObject.measurements = dataObject.measurements.data;
            }
            return canDoSportObject.canDoSport ? canDoSportObject.dataObject : undefined;
        }));
    },

    /**
     * Returns whether an athlete is already finished.
     * @param {Log} log - A log object
     * @param {Athlete} athlete - The Athlete
     * @param {Account[]} accounts - A list of accounts used to decrypt
     * @param {boolean} requireSignature - Only decrypt data if the signature can be verified. Should be true for final certificate creation.
     * @returns {boolean}
     */
    validate: function (log, athlete, accounts, requireSignature) {
        // collect data
        const data = this.getValidData(log, athlete, accounts, requireSignature);

        // sort for categories
        const categories = [];
        for (let st in data) {
            if (!data.hasOwnProperty(st)) continue;
            categories[data[st].category] = true;
        }

        return 3 &lt;= _.filter(categories, function (category) {
                return category;
            }).length;
    },

    /**
     * Calculates the score of one dataObject returned by the getValidData function.
     * @private
     * @param {object} dataObject - Object containing the data. The format is returned by getValidData.
     * @returns {number[]}
     */
    calculateOne: function (dataObject) {
        return _.map(dataObject.measurements, function (measurement) {
            const tmp_measurement = dataObject.conversionAddend + dataObject.conversionFactor * measurement;
            let score = 0;

            // select score from table
            for (let i = 0; i &lt;= 14; i++) {
                if ((dataObject.unit === 'm' &amp;&amp; tmp_measurement >= dataObject.scoreTable[i]) ||
                    (dataObject.unit !== 'm' &amp;&amp; tmp_measurement &lt;= dataObject.scoreTable[i])) {
                    score = i + 1;
                }
            }
            return score;
        });
    },

    /**
     * Calculates the score archived by a athlete. In case of incomplete data, the function will calculate as much as possible.
     * @param {Log} log - A log object
     * @param {Athlete} athlete - The Athlete
     * @param {Account[]} accounts - A list of accounts used to decrypt
     * @param {boolean} requireSignature - Only decrypt data if the signature can be verified. Should be true for final certificate creation.
     * @returns {{score: number, stScores: object}}
     */
    calculate: function (log, athlete, accounts, requireSignature) {
        // collect data
        const validData = this.getValidData(log, athlete, accounts, requireSignature);

        // get best score for each category
        const scores = [0, 0, 0, 0, 0, 0];
        const stScores = {};
        for (let vd in validData) {
            if (!validData.hasOwnProperty(vd)) continue;
            const score = this.calculateOne(validData[vd]);
            const bestScore = _.max(score);
            const category = validData[vd].category;

            if (!stScores.hasOwnProperty(validData[vd].stID)) {
                stScores[validData[vd].stID] = 0;
            }
            if (stScores[validData[vd].stID] &lt; bestScore) {
                stScores[validData[vd].stID] = bestScore;
            }

            log.info(validData[vd].name + ': ' + validData[vd].measurements + validData[vd].unit + ' (' + score + ') -> ' + bestScore);

            if (scores[category] &lt; bestScore) {
                scores[category] = bestScore;
            }
        }

        // take the three best categories
        return {
            score: _.reduce(_.sortBy(scores, function (num) {
                return num;
            }).splice(3, 3), function (mem, num) {
                return mem + num;
            }, 0),
            stScores: stScores
        };
    },

    /**
     * Returns information about the ct swimming.
     * @returns {object}
     */
    getInformation: function () {
        return require('./../../../data/swimming/information.json');
    },

    /**
     * Returns the min. score for the different certificates.
     * @param {Log} log - A log object
     * @param {Athlete} athlete - The Athlete
     * @returns {undefined|number[]}
     */
    getCertificateInfo: function (log, athlete) {
        if (athlete.check(log) === false) {
            log.error('Athletenprüfung fehlgechlagen. Bitte überprüfen sie die Einstellungen des Athleten (' + athlete.getFullName() + ').');
            return undefined;
        }
        return [15, 27];
    },

    /**
     * Generates the certificate for an athlete
     * @public
     * @param {Log} log - A log object
     * @param {Athlete} athlete - The Athlete
     * @param {Account[]} accounts - A list of accounts used to decrypt
     * @param {boolean} requireSignature - Only decrypt data if the signature can be verified. Should be true for final certificate creation.
     * @returns {{score: number, certificate: number}}
     */
    generateCertificate: function (log, athlete, accounts, requireSignature) {
        const calculateResult = this.calculate(log, athlete, accounts, requireSignature);
        const certificateInfo = this.getCertificateInfo(log, athlete);

        let certificate = -1;

        if (certificateInfo !== undefined) {
            if (calculateResult.score >= certificateInfo[1]) {
                certificate = 2;
            } else if (calculateResult.score >= certificateInfo[0]) {
                certificate = 1;
            } else {
                certificate = 0;
            }
        }

        return {
            score: calculateResult.score,
            stScores: calculateResult.stScores,
            certificate: certificate
        };
    }
};</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Mon Jan 09 2017 22:25:54 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
